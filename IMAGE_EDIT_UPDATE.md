# 图像编辑功能更新说明

## 更新时间
2025-12-12

## 更新内容

本次更新为Qt客户端添加了**图像编辑**功能,支持单图编辑和多图融合两种模式。

## 新增文件

### 1. `/ui/image_edit_widget.py` (598行)
图像编辑主组件,包含:

- **ImageEditWorker**: 异步工作线程
  - 调用API进行图像编辑
  - 下载生成的图片
  - 发送进度更新和结果信号

- **ImageGalleryWidget**: 结果画廊
  - 网格布局展示生成的图片
  - 点击查看大图
  - 空状态提示

- **ImageEditWidget**: 主界面组件
  - 模式切换(单图/多图)
  - 图片选择和管理
  - 参数配置面板
  - 结果展示

### 2. `/IMAGE_EDIT_FEATURE.md` (237行)
完整的功能文档,包含:
- 功能概述和特点
- 详细使用方法
- API接口说明
- 实现细节
- 测试建议

## 修改文件

### 1. `/core/api_client.py`
新增 `submit_image_edit()` 方法 (84行):
```python
def submit_image_edit(self, images: list, prompt: str, 
                     model: str = 'qwen-image-edit-plus',
                     n: int = 2, negative_prompt: str = "", 
                     prompt_extend: bool = True) -> Dict
```

功能:
- 支持单图或多图输入
- 自动识别图片格式并进行Base64编码
- 调用DashScope多模态生成API
- 返回JSON响应

### 2. `/ui/main_window.py`
- 导入 `ImageEditWidget`
- 替换占位符标签页为实际功能组件
- 集成到主窗口标签页

## 功能特性

### 🖼️ 单图编辑
- 选择1张图片进行编辑处理
- 支持深度图生成、风格转换、物体替换等
- 示例提示词:
  ```
  生成一张符合深度图的图像,遵循以下描述:
  一辆红色的破旧的自行车停在一条泥泞的小路上,
  背景是茂密的原始森林
  ```

### 🎭 多图融合
- 选择2-3张图片进行融合
- 支持人物换装、姿势迁移、场景融合等
- 示例提示词:
  ```
  图1中的女生穿着图2中的黑色裙子按图3的姿势坐下
  ```

### 参数配置
- **模型选择**: 
  - qwen-image-edit-plus
  - qwen-image-edit-plus-2025-10-30
- **生成数量**: 1-6张 (默认2张)
- **反向提示词**: 描述不希望出现的内容
- **智能改写**: 自动优化提示词

### 支持格式
- JPG/JPEG
- PNG
- BMP
- TIFF
- WEBP
- GIF

## 用户界面

### 左侧配置面板
```
┌─────────────────────────┐
│ 编辑模式: 🖼️单图/🎭多图   │
├─────────────────────────┤
│ 选择图片列表             │
│ [添加图片] [清空]        │
├─────────────────────────┤
│ 编辑描述(必填)           │
├─────────────────────────┤
│ 反向提示词(可选)         │
├─────────────────────────┤
│ 模型选择                 │
│ 生成数量: 1-6           │
├─────────────────────────┤
│ [开始编辑]              │
│ 状态信息                │
└─────────────────────────┘
```

### 右侧结果画廊
```
┌─────────────────────────┐
│ ┌────┐ ┌────┐ ┌────┐   │
│ │图片│ │图片│ │图片│   │
│ │ 1  │ │ 2  │ │ 3  │   │
│ └────┘ └────┘ └────┘   │
│ ┌────┐ ┌────┐ ┌────┐   │
│ │图片│ │图片│ │图片│   │
│ │ 4  │ │ 5  │ │ 6  │   │
│ └────┘ └────┘ └────┘   │
└─────────────────────────┘
```

## 工作流程

1. **选择模式**: 单图编辑或多图融合
2. **添加图片**: 从工程inputs文件夹选择图片
3. **输入提示词**: 描述想要的编辑效果
4. **配置参数**: 模型、数量、反向提示词等
5. **提交任务**: 点击"开始编辑"
6. **等待处理**: 显示实时进度
7. **查看结果**: 在右侧画廊中查看生成的图片
8. **保存到工程**: 自动保存到inputs文件夹

## API调用流程

```
┌──────────────┐
│ 用户点击生成  │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 验证输入参数  │
└──────┬───────┘
       │
       ▼
┌──────────────────┐
│ 读取图片并Base64  │
└──────┬───────────┘
       │
       ▼
┌──────────────────────┐
│ 调用submit_image_edit │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────────┐
│ POST /multimodal-generation │
└──────┬───────────────────┘
       │
       ▼
┌──────────────┐
│ 解析响应数据  │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 下载生成图片  │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 更新UI显示   │
└──────────────┘
```

## 错误处理

### 输入验证
- 检查是否选择了图片
- 验证图片数量是否符合模式要求
- 验证提示词是否为空
- 检查工程是否已打开

### API错误
- InvalidApiKey: API密钥无效
- InternalError: 服务器内部错误
- InvalidParameter: 参数错误
- 网络超时: 请求超时

### 用户友好提示
- 所有错误都会显示MessageBox
- 状态标签实时显示进度
- 失败后自动恢复按钮状态

## 技术要点

### 1. Base64编码
```python
with open(image_path, 'rb') as f:
    image_data = base64.b64encode(f.read()).decode('utf-8')

# 格式: data:{mime_type};base64,{base64_data}
content.append({
    "image": f"data:{mime_type};base64,{image_data}"
})
```

### 2. 异步处理
使用 `QThread` 避免UI阻塞:
```python
class ImageEditWorker(QThread):
    finished = pyqtSignal(list, dict)
    error = pyqtSignal(str)
    progress = pyqtSignal(str)
```

### 3. 信号槽机制
```python
self.worker.finished.connect(self.on_edit_finished)
self.worker.error.connect(self.on_edit_error)
self.worker.progress.connect(self.on_edit_progress)
```

## 测试验证

✅ 代码语法检查通过
✅ 模块导入测试通过
✅ API方法签名正确
✅ UI组件定义正确

## 使用示例

### 启动应用
```bash
cd /Users/chenleiyu/Desktop/wanx/qt_client
python3 main.py
```

### 操作步骤
1. 打开或创建一个工程
2. 点击"✂️ 图像编辑"标签页
3. 选择编辑模式
4. 添加图片并输入提示词
5. 点击"开始编辑"
6. 查看生成结果

## 注意事项

1. **API密钥**: 需要在设置中配置有效的DASHSCOPE_API_KEY
2. **图片格式**: 确保图片格式在支持范围内
3. **网络连接**: 需要稳定的网络连接
4. **配额消耗**: 每次编辑会消耗API配额
5. **生成时间**: 根据图片复杂度,处理时间可能较长

## 兼容性

- ✅ Python 3.6+
- ✅ PyQt5
- ✅ macOS/Linux/Windows
- ✅ 与现有功能无冲突

## 后续计划

- [ ] 批量编辑支持
- [ ] 历史记录保存
- [ ] 编辑参数预设
- [ ] 更多模型支持
- [ ] 对比视图
- [ ] 导出功能优化

## 总结

本次更新成功为Qt客户端添加了完整的图像编辑功能,包括:
- ✅ 单图编辑
- ✅ 多图融合
- ✅ 参数配置
- ✅ 结果展示
- ✅ 错误处理
- ✅ 完整文档

用户现在可以直接在客户端中进行图像编辑和多图融合操作,无需切换到其他工具!
