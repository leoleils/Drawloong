# 设置指南 - API 密钥配置

本指南详细介绍如何在 QT 客户端中配置 API 密钥。

## 目录
1. [首次启动配置](#首次启动配置)
2. [打开设置对话框](#打开设置对话框)
3. [配置 API 密钥](#配置-api-密钥)
4. [修改 API 密钥](#修改-api-密钥)
5. [常见问题](#常见问题)

---

## 首次启动配置

### 步骤 1: 启动应用

运行 QT 客户端应用：

```bash
cd qt_client
python main.py
# 或使用启动脚本
./run.sh  # macOS/Linux
run.bat   # Windows
```

### 步骤 2: 配置提示

首次启动时，如果未检测到 API 密钥，会弹出提示对话框：

```
┌─────────────────────────────────────┐
│         配置提醒                    │
├─────────────────────────────────────┤
│                                     │
│  未检测到 API 密钥配置              │
│                                     │
│  是否现在打开设置页面配置？          │
│                                     │
│         [是]        [否]            │
└─────────────────────────────────────┘
```

- **点击 "是"**: 直接打开设置对话框
- **点击 "否"**: 稍后手动配置（生成功能将被禁用）

---

## 打开设置对话框

有多种方式可以打开设置对话框：

### 方式 1: 点击设置按钮

在主窗口右上角，点击 **"⚙ 设置"** 按钮：

```
┌────────────────────────────────────────────────┐
│  图生视频客户端              [⚙ 设置]          │
├────────────────────────────────────────────────┤
│                                                │
│  [上传区域]              [配置面板]            │
│                                                │
└────────────────────────────────────────────────┘
```

### 方式 2: 使用菜单

点击菜单栏 **"文件"** -> **"设置"**：

```
┌────────────────────────────────────────┐
│ 文件(F)  帮助(H)                       │
├────────────────────────────────────────┤
│  ├─ 设置           Ctrl+,             │
│  ├─ ─────────────                     │
│  └─ 退出           Ctrl+Q             │
└────────────────────────────────────────┘
```

### 方式 3: 使用快捷键

按下快捷键：
- **Windows/Linux**: `Ctrl + ,`
- **macOS**: `Cmd + ,`

---

## 配置 API 密钥

### 设置对话框界面

```
┌─────────────────────────────────────────────────┐
│                   设置                          │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌─ API 配置 ─────────────────────────────┐   │
│  │                                         │   │
│  │  请输入你的阿里云 DashScope API 密钥    │   │
│  │  获取地址: https://dashscope.console... │   │
│  │                                         │   │
│  │  API 密钥 (SK):                         │   │
│  │  ┌────────────────────────────────────┐ │   │
│  │  │ sk-************************       │ │   │
│  │  └────────────────────────────────────┘ │   │
│  │                                         │   │
│  │  [✓] 显示密钥                           │   │
│  │                                         │   │
│  │  ✓ API 密钥已配置                       │   │
│  │                                         │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│         [测试连接]  [取消]  [保存]              │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 填写步骤

1. **输入 API 密钥**
   - 在 "API 密钥 (SK)" 输入框中粘贴你的密钥
   - 密钥格式：`sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`
   - 默认以密码形式显示（******）

2. **显示/隐藏密钥**（可选）
   - 勾选 "显示密钥" 复选框可以查看完整密钥
   - 取消勾选则重新隐藏

3. **测试连接**（可选）
   - 点击 "测试连接" 按钮
   - 系统会验证密钥格式是否正确
   - 提示是否以 'sk-' 开头

4. **保存配置**
   - 点击 "保存" 按钮
   - 系统会将密钥安全存储到本地配置
   - 提示 "设置已保存"

### 状态指示

配置完成后，状态会显示：

- ✓ **API 密钥已配置**（绿色）- 密钥有效
- ⚠ **未配置 API 密钥**（红色）- 密钥缺失或无效

---

## 修改 API 密钥

### 何时需要修改

- 密钥过期或失效
- 切换到新的阿里云账号
- 密钥泄露需要更换
- 定期安全维护

### 修改步骤

1. **打开设置对话框**
   - 使用任一方式打开设置

2. **清空旧密钥**
   - 勾选 "显示密钥" 查看当前密钥
   - 选中并删除全部内容

3. **输入新密钥**
   - 粘贴新的 API 密钥
   - 验证格式正确

4. **保存更改**
   - 点击 "保存" 按钮
   - 新密钥立即生效，无需重启应用

### 验证修改

修改后可以通过以下方式验证：

1. 尝试生成一个测试视频
2. 查看状态栏提示 "API 密钥已更新"
3. 生成按钮应该可用（非灰色）

---

## 常见问题

### Q1: 密钥存储在哪里？

**答：** API 密钥安全存储在系统配置中（QSettings）：

- **Windows**: 
  ```
  HKEY_CURRENT_USER\Software\WanX\ImageToVideo
  键名: api_key
  ```

- **macOS**: 
  ```
  ~/Library/Preferences/com.WanX.ImageToVideo.plist
  ```

- **Linux**: 
  ```
  ~/.config/WanX/ImageToVideo.conf
  ```

### Q2: 密钥是否加密？

**答：** 是的。QSettings 使用系统级加密机制：
- Windows 使用注册表的默认加密
- macOS 使用 plist 文件权限保护
- Linux 使用文件权限 (600) 保护

仅当前用户可以访问。

### Q3: 可以同时使用 .env 文件吗？

**答：** 可以。优先级顺序：

1. QSettings（界面配置）- **优先**
2. .env 文件 - 备用

如果在界面中配置了密钥，将优先使用界面配置的值。

### Q4: 忘记密钥怎么办？

**解决方法：**

1. 打开设置对话框
2. 勾选 "显示密钥" 查看当前配置的密钥
3. 如果没有配置，前往阿里云控制台重新获取

### Q5: 提示 "API 密钥格式不正确"

**解决方法：**

检查密钥是否符合以下格式：
- 以 `sk-` 开头
- 长度通常为 40-50 个字符
- 只包含字母、数字和 `-`

正确示例：
```
sk-1234567890abcdefghijklmnopqrstuv
```

错误示例：
```
1234567890abcdefghijklmnopqrstuv  ❌ (缺少 sk- 前缀)
sk-12345                           ❌ (长度过短)
sk 1234567890abcdefg               ❌ (包含空格)
```

### Q6: 设置无法保存

**可能原因及解决方法：**

1. **权限问题**
   - Windows: 以管理员身份运行
   - Linux/macOS: 检查配置目录权限
   ```bash
   chmod 700 ~/.config/WanX
   ```

2. **目录不存在**
   - Linux: 手动创建配置目录
   ```bash
   mkdir -p ~/.config/WanX
   ```

3. **磁盘空间不足**
   - 清理磁盘空间

### Q7: 多台电脑如何同步配置？

**方法：**

由于 API 密钥存储在本地，不会自动同步。可以：

1. **手动同步**
   - 在每台电脑上分别配置相同的密钥

2. **使用 .env 文件**（不推荐）
   - 将 .env 文件同步到多台电脑
   - 注意：不要将密钥提交到 Git！

3. **云同步工具**
   - Windows: 使用注册表同步工具
   - macOS: 使用 iCloud 同步 plist
   - Linux: 同步 ~/.config 目录

---

## 安全建议

### ✅ 应该做的

1. **定期更换密钥**
   - 建议每 3-6 个月更换一次
   - 在阿里云控制台可以生成新密钥

2. **保护密钥安全**
   - 不要截图或分享密钥
   - 不要在公共场合展示密钥
   - 不要将密钥提交到版本控制

3. **使用密码模式**
   - 默认隐藏密钥显示
   - 仅在必要时才显示

4. **监控使用情况**
   - 定期检查阿里云控制台的调用记录
   - 发现异常立即更换密钥

### ❌ 不应该做的

1. **不要硬编码**
   - 不要在代码中直接写入密钥

2. **不要共享密钥**
   - 每个用户应使用独立密钥
   - 不要将密钥发送给他人

3. **不要公开存储**
   - 不要存储在公开的文件中
   - 不要上传到云端未加密的位置

---

## 获取 API 密钥

### 步骤 1: 访问阿里云控制台

打开浏览器访问：
```
https://dashscope.console.aliyun.com/
```

### 步骤 2: 登录账号

- 使用阿里云账号登录
- 如果没有账号，先注册

### 步骤 3: 开通服务

- 首次使用需要开通 DashScope 服务
- 按照提示完成开通流程

### 步骤 4: 创建 API Key

1. 在控制台找到 "API Key 管理"
2. 点击 "创建新的 API Key"
3. 设置密钥名称（可选）
4. 复制生成的密钥

### 步骤 5: 配置到客户端

1. 复制密钥
2. 打开 QT 客户端设置对话框
3. 粘贴密钥
4. 保存

---

## 技术细节

### QSettings 配置

```python
# 组织名称
organization = 'WanX'

# 应用名称  
application = 'ImageToVideo'

# 配置键
key = 'api_key'

# 读取
qsettings = QSettings(organization, application)
api_key = qsettings.value(key, default_value)

# 写入
qsettings.setValue(key, api_key)
qsettings.sync()
```

### 配置文件位置

可以通过以下代码查看实际存储位置：

```python
from PyQt5.QtCore import QSettings

settings = QSettings('WanX', 'ImageToVideo')
print(settings.fileName())
```

---

## 更新记录

- **v1.1.0** (2025-12-11)
  - 新增设置对话框
  - 支持界面配置 API 密钥
  - 添加密钥显示/隐藏功能
  - 实现 QSettings 存储

---

**提示**: 如有其他问题，请查看 [CHANGELOG.md](CHANGELOG.md) 或提交 Issue。
