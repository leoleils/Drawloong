# 配置迁移指南 - v1.17.1

## 🔄 重要变更

从 v1.17.1 开始，烛龙绘影不再读取系统环境变量中的API密钥，**仅使用应用内配置**。

## 📋 变更详情

### 之前的配置方式（已弃用）
- ✅ QSettings（系统配置）- 优先
- ✅ 环境变量 (.env文件) - 备用
- ✅ 系统环境变量 - 备用

### 新的配置方式（v1.17.1+）
- ✅ **仅 QSettings（系统配置）**
- ❌ 不再读取环境变量
- ❌ 不再读取系统环境变量

## 🚀 自动迁移

### 迁移机制
应用启动时会自动检查并迁移配置：

1. **检查 QSettings**: 如果已有API密钥，直接使用
2. **检查 .env 文件**: 如果QSettings为空，尝试从.env文件读取并迁移
3. **迁移完成**: 将.env中的密钥保存到QSettings

### 迁移日志
```
已从.env文件迁移API密钥到系统配置
```

## 📁 配置存储位置

### QSettings 存储路径
- **Windows**: `HKEY_CURRENT_USER\Software\WanX\ImageToVideo`
- **macOS**: `~/Library/Preferences/com.WanX.ImageToVideo.plist`
- **Linux**: `~/.config/WanX/ImageToVideo.conf`

### 配置键名
- API密钥: `api_key`
- 主题: `fluent_theme`
- 强调色: `accent_color`

## 🎯 推荐操作步骤

### 对于新用户
1. 启动应用
2. 点击"设置"按钮
3. 输入API密钥
4. 点击保存

### 对于现有用户
1. **无需操作** - 应用会自动迁移现有配置
2. 可选：删除 `.env` 文件中的API密钥（迁移后不再需要）
3. 可选：在设置界面确认API密钥已正确配置

## 🔒 安全性提升

### 新配置方式的优势
- ✅ **系统级加密**: QSettings使用操作系统的加密机制
- ✅ **权限保护**: 只有当前用户可访问
- ✅ **界面友好**: 密码模式输入，自动隐藏
- ✅ **实时生效**: 修改后立即生效，无需重启

### 移除的风险
- ❌ 不再有明文存储在文件中的风险
- ❌ 不再有误提交到版本控制的风险
- ❌ 不再有环境变量泄露的风险

## 🛠️ 开发者说明

### 代码变更
```python
# 之前的实现
self.DASHSCOPE_API_KEY = self.qsettings.value(
    'api_key', 
    os.environ.get('DASHSCOPE_API_KEY', '')  # 已移除
)

# 新的实现
self.DASHSCOPE_API_KEY = self.qsettings.value('api_key', '')
```

### 迁移逻辑
```python
def _migrate_from_env_file(self):
    """从.env文件迁移API密钥到QSettings"""
    # 自动检测并迁移.env文件中的配置
```

## 📝 常见问题

### Q: 我的API密钥会丢失吗？
**A**: 不会。应用会自动从.env文件迁移到系统配置。

### Q: 我需要重新配置吗？
**A**: 大多数情况下不需要。如果之前使用界面配置，无需任何操作。

### Q: .env文件还有用吗？
**A**: 仅在首次迁移时有用。迁移后可以删除其中的API密钥。

### Q: 如何验证迁移成功？
**A**: 在设置界面查看API密钥是否正确显示。

### Q: 如何手动配置？
**A**: 启动应用 → 设置 → 输入API密钥 → 保存

## 🔄 回退方案

如果遇到问题，可以：
1. 在设置界面重新输入API密钥
2. 检查系统配置文件是否正确
3. 联系技术支持

---

**更新日期**: 2025年12月24日  
**适用版本**: v1.17.1+  
**影响范围**: API密钥配置机制