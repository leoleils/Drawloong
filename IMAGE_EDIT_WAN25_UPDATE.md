# å›¾åƒç¼–è¾‘åŠŸèƒ½ - æ–°å¢ä¸‡ç›¸2.5æ¨¡å‹æ”¯æŒ

## æ›´æ–°æ—¶é—´
2025-12-12

## æ›´æ–°å†…å®¹

ä¸ºå›¾åƒç¼–è¾‘åŠŸèƒ½æ–°å¢ **wan2.5-i2i-preview** æ¨¡å‹æ”¯æŒ,è¿™æ˜¯é˜¿é‡Œäº‘ä¸‡ç›¸ç³»åˆ—çš„æœ€æ–°å›¾åƒç¼–è¾‘æ¨¡å‹,æä¾›æ›´ä¼˜è´¨çš„ç¼–è¾‘æ•ˆæœã€‚

## æ–°å¢æ¨¡å‹

### wan2.5-i2i-preview (æ¨è)
- **ç±»å‹**: ä¸‡ç›¸2.5å›¾åƒç¼–è¾‘æ¨¡å‹
- **æ¨¡å¼**: å¼‚æ­¥å¤„ç†
- **APIç«¯ç‚¹**: `/services/aigc/image2image/image-synthesis`
- **ç‰¹ç‚¹**:
  - âœ… æ”¯æŒå•å›¾ç¼–è¾‘å’Œå¤šå›¾èåˆ
  - âœ… å¼‚æ­¥å¤„ç†,æ›´ç¨³å®š
  - âœ… æ•ˆæœæ›´ä¼˜è´¨
  - âœ… æ”¯æŒ1-6å¼ å›¾ç‰‡è¾“å‡º

## æ ¸å¿ƒæ”¹åŠ¨

### 1. APIå®¢æˆ·ç«¯ (`core/api_client.py`)

#### æ–°å¢æ–¹æ³•

**submit_image_edit()** - æ™ºèƒ½è·¯ç”±
```python
def submit_image_edit(self, images: list, prompt: str, model: str = 'qwen-image-edit-plus',
                     n: int = 2, negative_prompt: str = "", prompt_extend: bool = True) -> Dict
```
- è‡ªåŠ¨åˆ¤æ–­æ¨¡å‹ç±»å‹
- ä¸‡ç›¸2.5 â†’ å¼‚æ­¥API
- é€šä¹‰åƒé—® â†’ åŒæ­¥API

**_submit_wan25_image_edit()** - ä¸‡ç›¸2.5å¼‚æ­¥æäº¤
```python
def _submit_wan25_image_edit(self, images: list, prompt: str, model: str,
                            n: int, prompt_extend: bool) -> Dict
```
- ä½¿ç”¨ `image2image/image-synthesis` ç«¯ç‚¹
- è®¾ç½® `X-DashScope-Async: enable` å¤´
- è¿”å›ä»»åŠ¡ID

**_submit_qwen_image_edit()** - é€šä¹‰åƒé—®åŒæ­¥æäº¤
```python
def _submit_qwen_image_edit(self, images: list, prompt: str, model: str,
                           n: int, negative_prompt: str, prompt_extend: bool) -> Dict
```
- ä½¿ç”¨ `multimodal-generation/generation` ç«¯ç‚¹
- åŒæ­¥è¿”å›ç»“æœ

**query_image_edit_task()** - ä»»åŠ¡æŸ¥è¯¢
```python
def query_image_edit_task(self, task_id: str) -> Dict
```
- æŸ¥è¯¢å¼‚æ­¥ä»»åŠ¡çŠ¶æ€
- å¤ç”¨ç°æœ‰ `query_task()` æ–¹æ³•

### 2. Workerçº¿ç¨‹ (`ui/image_edit_widget.py`)

#### ä¿®æ”¹ ImageEditWorker

**run()** - æ™ºèƒ½è°ƒåº¦
```python
def run(self):
    is_wan25 = self.model.startswith('wan2.5')
    if is_wan25:
        self._run_async_mode()  # å¼‚æ­¥æ¨¡å¼
    else:
        self._run_sync_mode()   # åŒæ­¥æ¨¡å¼
```

**_run_async_mode()** - å¼‚æ­¥å¤„ç†æµç¨‹
1. æäº¤å¼‚æ­¥ä»»åŠ¡ â†’ è·å– task_id
2. è½®è¯¢ä»»åŠ¡çŠ¶æ€ (æœ€å¤š60æ¬¡,æ¯æ¬¡2ç§’)
3. SUCCEEDED â†’ ä¸‹è½½å›¾ç‰‡
4. FAILED â†’ é”™è¯¯æç¤º
5. è¶…æ—¶ â†’ æç¤ºé‡è¯•

**_run_sync_mode()** - åŒæ­¥å¤„ç†æµç¨‹
1. æäº¤ä»»åŠ¡
2. ç›´æ¥è·å–ç»“æœ
3. ä¸‹è½½å›¾ç‰‡

**_download_images()** - å›¾ç‰‡ä¸‹è½½
- ç»Ÿä¸€çš„å›¾ç‰‡ä¸‹è½½é€»è¾‘
- æ”¯æŒå¤šå¼ å›¾ç‰‡æ‰¹é‡ä¸‹è½½

### 3. UIç»„ä»¶æ›´æ–°

#### æ¨¡å‹é€‰æ‹©å™¨
```python
self.model_combo.addItem("ğŸŒŸ wan2.5-i2i-previewï¼ˆæ¨èï¼‰", "wan2.5-i2i-preview")
self.model_combo.addItem("qwen-image-edit-plus", "qwen-image-edit-plus")
self.model_combo.addItem("qwen-image-edit-plus-2025-10-30", "qwen-image-edit-plus-2025-10-30")
```

#### æ¨¡å‹è¯´æ˜æ ‡ç­¾
- ä¸‡ç›¸2.5: "ğŸŒŸ ä¸‡ç›¸2.5æ¨¡å‹:æ”¯æŒå•å›¾ç¼–è¾‘å’Œå¤šå›¾èåˆ,å¼‚æ­¥å¤„ç†,æ•ˆæœæ›´ä¼˜"
- é€šä¹‰åƒé—®: "é€šä¹‰åƒé—®æ¨¡å‹:æ”¯æŒå•å›¾ç¼–è¾‘å’Œå¤šå›¾èåˆ,åŒæ­¥å¤„ç†"

#### åå‘æç¤ºè¯åŠ¨æ€æ§åˆ¶
- ä¸‡ç›¸2.5: ç¦ç”¨åå‘æç¤ºè¯è¾“å…¥æ¡†
- é€šä¹‰åƒé—®: å¯ç”¨åå‘æç¤ºè¯è¾“å…¥æ¡†

## APIè°ƒç”¨ç¤ºä¾‹

### å•å›¾ç¼–è¾‘ (ä¸‡ç›¸2.5)

```bash
curl --location 'https://dashscope.aliyuncs.com/api/v1/services/aigc/image2image/image-synthesis' \
-H 'X-DashScope-Async: enable' \
-H "Authorization: Bearer $DASHSCOPE_API_KEY" \
-H 'Content-Type: application/json' \
-d '{
    "model": "wan2.5-i2i-preview",
    "input": {
        "prompt": "å°†èŠ±å‰è¿è¡£è£™æ¢æˆä¸€ä»¶å¤å¤é£æ ¼çš„è•¾ä¸é•¿è£™ï¼Œé¢†å£å’Œè¢–å£æœ‰ç²¾è‡´çš„åˆºç»£ç»†èŠ‚ã€‚",
        "images": [
            "data:image/jpeg;base64,{base64_data}"
        ]
    },
    "parameters": {
        "prompt_extend": true,
        "n": 1
    }
}'
```

### å¤šå›¾èåˆ (ä¸‡ç›¸2.5)

```bash
curl --location 'https://dashscope.aliyuncs.com/api/v1/services/aigc/image2image/image-synthesis' \
-H 'X-DashScope-Async: enable' \
-H "Authorization: Bearer $DASHSCOPE_API_KEY" \
-H 'Content-Type: application/json' \
-d '{
    "model": "wan2.5-i2i-preview",
    "input": {
        "prompt": "å°†å›¾1ä¸­çš„é—¹é’Ÿæ”¾ç½®åˆ°å›¾2çš„é¤æ¡Œçš„èŠ±ç“¶æ—è¾¹ä½ç½®",
        "images": [
            "data:image/jpeg;base64,{base64_data_1}",
            "data:image/jpeg;base64,{base64_data_2}"
        ]
    },
    "parameters": {
        "n": 1
    }
}'
```

### å“åº”æ ¼å¼

**æäº¤æˆåŠŸ**:
```json
{
    "output": {
        "task_status": "PENDING",
        "task_id": "0385dc79-5ff8-4d82-bcb6-xxxxxx"
    },
    "request_id": "4909100c-7b5a-9f92-bfe5-xxxxxx"
}
```

**æŸ¥è¯¢ç»“æœ (æˆåŠŸ)**:
```json
{
    "output": {
        "task_status": "SUCCEEDED",
        "results": [
            {
                "url": "https://dashscope-result-sz.oss-cn-shenzhen.aliyuncs.com/xxx.png"
            }
        ]
    },
    "request_id": "xxx"
}
```

**æŸ¥è¯¢ç»“æœ (å¤±è´¥)**:
```json
{
    "output": {
        "task_status": "FAILED",
        "code": "InternalError",
        "message": "å¤„ç†å¤±è´¥"
    },
    "request_id": "xxx"
}
```

## å¤„ç†æµç¨‹å¯¹æ¯”

### åŒæ­¥æ¨¡å¼ (é€šä¹‰åƒé—®)
```
æäº¤ä»»åŠ¡ â†’ ç­‰å¾…å¤„ç† â†’ ç›´æ¥è¿”å›ç»“æœ â†’ ä¸‹è½½å›¾ç‰‡
```

### å¼‚æ­¥æ¨¡å¼ (ä¸‡ç›¸2.5)
```
æäº¤ä»»åŠ¡ â†’ è·å–task_id â†’ è½®è¯¢çŠ¶æ€ â†’ SUCCEEDED â†’ ä¸‹è½½å›¾ç‰‡
         â†“
    PENDING/RUNNING (ç»§ç»­è½®è¯¢)
         â†“
    FAILED (è¿”å›é”™è¯¯)
```

## ä½¿ç”¨ç¤ºä¾‹

### å•å›¾ç¼–è¾‘

1. é€‰æ‹©æ¨¡å‹: **ğŸŒŸ wan2.5-i2i-previewï¼ˆæ¨èï¼‰**
2. é€‰æ‹©æ¨¡å¼: ğŸ–¼ï¸ å•å›¾ç¼–è¾‘
3. æ·»åŠ å›¾ç‰‡: 1å¼ äººç‰©ç…§ç‰‡
4. ç¼–è¾‘æè¿°:
   ```
   å°†èŠ±å‰è¿è¡£è£™æ¢æˆä¸€ä»¶å¤å¤é£æ ¼çš„è•¾ä¸é•¿è£™ï¼Œ
   é¢†å£å’Œè¢–å£æœ‰ç²¾è‡´çš„åˆºç»£ç»†èŠ‚ã€‚
   ```
5. ç”Ÿæˆæ•°é‡: 2
6. ç‚¹å‡»"å¼€å§‹ç¼–è¾‘"
7. ç­‰å¾…å¼‚æ­¥å¤„ç†å®Œæˆ

### å¤šå›¾èåˆ

1. é€‰æ‹©æ¨¡å‹: **ğŸŒŸ wan2.5-i2i-previewï¼ˆæ¨èï¼‰**
2. é€‰æ‹©æ¨¡å¼: ğŸ­ å¤šå›¾èåˆ
3. æ·»åŠ å›¾ç‰‡:
   - å›¾1: é—¹é’Ÿç…§ç‰‡
   - å›¾2: é¤æ¡Œåœºæ™¯
4. ç¼–è¾‘æè¿°:
   ```
   å°†å›¾1ä¸­çš„é—¹é’Ÿæ”¾ç½®åˆ°å›¾2çš„é¤æ¡Œçš„èŠ±ç“¶æ—è¾¹ä½ç½®
   ```
5. ç”Ÿæˆæ•°é‡: 2
6. ç‚¹å‡»"å¼€å§‹ç¼–è¾‘"
7. ç­‰å¾…å¼‚æ­¥å¤„ç†å®Œæˆ

## æ¨¡å‹å¯¹æ¯”

| ç‰¹æ€§ | wan2.5-i2i-preview | qwen-image-edit-plus |
|------|-------------------|---------------------|
| å¤„ç†æ–¹å¼ | å¼‚æ­¥ | åŒæ­¥ |
| åå‘æç¤ºè¯ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| å•å›¾ç¼–è¾‘ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| å¤šå›¾èåˆ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| è¾“å‡ºæ•°é‡ | 1-6å¼  | 1-6å¼  |
| æ•ˆæœè´¨é‡ | â­â­â­â­â­ | â­â­â­â­ |
| å¤„ç†é€Ÿåº¦ | ä¸­ç­‰ | å¿« |
| æ¨èåº¦ | ğŸŒŸ æ¨è | å¯é€‰ |

## æŠ€æœ¯äº®ç‚¹

### 1. æ™ºèƒ½è·¯ç”±
è‡ªåŠ¨æ ¹æ®æ¨¡å‹åç§°é€‰æ‹©æ­£ç¡®çš„APIç«¯ç‚¹å’Œå¤„ç†æ–¹å¼:
```python
is_wan25 = model.startswith('wan2.5')
if is_wan25:
    return self._submit_wan25_image_edit(...)
else:
    return self._submit_qwen_image_edit(...)
```

### 2. å¼‚æ­¥è½®è¯¢
å®ç°äº†ç¨³å®šçš„ä»»åŠ¡è½®è¯¢æœºåˆ¶:
- æœ€å¤šè½®è¯¢60æ¬¡ (çº¦2åˆ†é’Ÿ)
- æ¯æ¬¡é—´éš”2ç§’
- æ”¯æŒ PENDING/RUNNING/SUCCEEDED/FAILED çŠ¶æ€

### 3. åŠ¨æ€UI
æ ¹æ®æ¨¡å‹ç±»å‹åŠ¨æ€è°ƒæ•´UIçŠ¶æ€:
- ä¸‡ç›¸2.5: ç¦ç”¨åå‘æç¤ºè¯
- é€šä¹‰åƒé—®: å¯ç”¨åå‘æç¤ºè¯

### 4. ç»Ÿä¸€æ¥å£
å¯¹å¤–æä¾›ç»Ÿä¸€çš„ `submit_image_edit()` æ¥å£,å†…éƒ¨è‡ªåŠ¨å¤„ç†å·®å¼‚

## æ³¨æ„äº‹é¡¹

### 1. APIå¯†é’¥
ç¡®ä¿åœ¨è®¾ç½®ä¸­é…ç½®äº†æœ‰æ•ˆçš„ `DASHSCOPE_API_KEY`

### 2. å¼‚æ­¥å¤„ç†
ä¸‡ç›¸2.5ä½¿ç”¨å¼‚æ­¥æ¨¡å¼,å¤„ç†æ—¶é—´å¯èƒ½è¾ƒé•¿,è¯·è€å¿ƒç­‰å¾…

### 3. åå‘æç¤ºè¯
ä¸‡ç›¸2.5ä¸æ”¯æŒåå‘æç¤ºè¯,é€‰æ‹©è¯¥æ¨¡å‹æ—¶è¾“å…¥æ¡†ä¼šè‡ªåŠ¨ç¦ç”¨

### 4. ç½‘ç»œè¶…æ—¶
å¼‚æ­¥ä»»åŠ¡å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´,å¦‚æœè¶…æ—¶è¯·é‡è¯•

### 5. é…é¢æ¶ˆè€—
æ¯æ¬¡è°ƒç”¨éƒ½ä¼šæ¶ˆè€—APIé…é¢,è¯·åˆç†ä½¿ç”¨

## æµ‹è¯•éªŒè¯

âœ… ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡
âœ… APIå®¢æˆ·ç«¯æ–¹æ³•éªŒè¯é€šè¿‡
âœ… Workerçº¿ç¨‹é€»è¾‘éªŒè¯é€šè¿‡
âœ… UIç»„ä»¶æ›´æ–°éªŒè¯é€šè¿‡

## æ›´æ–°æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
1. `/core/api_client.py` (+71è¡Œ)
   - æ–°å¢ `_submit_wan25_image_edit()`
   - æ–°å¢ `_submit_qwen_image_edit()`
   - æ–°å¢ `query_image_edit_task()`
   - ä¿®æ”¹ `submit_image_edit()` æ”¯æŒæ™ºèƒ½è·¯ç”±

2. `/ui/image_edit_widget.py` (+182è¡Œ)
   - ä¿®æ”¹ `ImageEditWorker.run()` æ”¯æŒå¼‚æ­¥/åŒæ­¥æ¨¡å¼
   - æ–°å¢ `_run_async_mode()` å¼‚æ­¥å¤„ç†
   - æ–°å¢ `_run_sync_mode()` åŒæ­¥å¤„ç†
   - æ–°å¢ `_download_images()` ç»Ÿä¸€ä¸‹è½½
   - æ–°å¢ `on_model_changed()` æ¨¡å‹åˆ‡æ¢äº‹ä»¶
   - æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨UI

### æ–°å¢çš„æ–‡ä»¶
1. `/IMAGE_EDIT_WAN25_UPDATE.md` (æœ¬æ–‡æ¡£)

## åç»­ä¼˜åŒ–

- [ ] æ”¯æŒä»»åŠ¡å–æ¶ˆåŠŸèƒ½
- [ ] ä¼˜åŒ–è½®è¯¢ç­–ç•¥ (æŒ‡æ•°é€€é¿)
- [ ] æ·»åŠ ä»»åŠ¡è¿›åº¦ç™¾åˆ†æ¯”æ˜¾ç¤º
- [ ] æ”¯æŒæ‰¹é‡ä»»åŠ¡å¤„ç†
- [ ] å†å²ä»»åŠ¡è®°å½•å’Œæ¢å¤

## æ€»ç»“

æœ¬æ¬¡æ›´æ–°æˆåŠŸä¸ºå›¾åƒç¼–è¾‘åŠŸèƒ½æ·»åŠ äº†ä¸‡ç›¸2.5æ¨¡å‹æ”¯æŒ,å®ç°äº†:
- âœ… å¼‚æ­¥ä»»åŠ¡æäº¤å’Œè½®è¯¢
- âœ… æ™ºèƒ½æ¨¡å‹è·¯ç”±
- âœ… åŠ¨æ€UIæ§åˆ¶
- âœ… ç»Ÿä¸€çš„APIæ¥å£

ç”¨æˆ·ç°åœ¨å¯ä»¥ä½¿ç”¨æœ€æ–°çš„ä¸‡ç›¸2.5æ¨¡å‹è·å¾—æ›´ä¼˜è´¨çš„å›¾åƒç¼–è¾‘æ•ˆæœ! ğŸ‰
